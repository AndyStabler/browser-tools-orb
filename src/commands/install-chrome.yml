description: >
  Install Google's Chrome browser, for use in browser testing. Note:
  only the latest stable release can be installed, as Google does not
  maintain a public archive of previous releases. Supports Debian/Ubuntu
  Linux, Alpine Linux (via Chromium), and macOS environments.

steps:
  - run:
      name: Install Google Chrome
      command: |
        if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi

        installation_check () {
          if cat /etc/issue >> /dev/null 2>&1 | grep Alpine >> /dev/null 2>&1; then
            if command -v chromium-browser >> /dev/null 2>&1; then
              echo "Google Chrome (via Chromium) is already installed"
              exit 0
            else
              echo "Google Chrome (via Chromium) is not currently installed; installing it"
            fi
          else
            if command -v google-chrome >> /dev/null 2>&1; then
              echo "Google Chrome is already installed"
              exit 0
            else
              echo "Google Chrome is not currently installed; installing it"
            fi
          fi
        }

        installation_check

        if uname -a | grep Darwin >> /dev/null 2>&1; then
          HOMEBREW_NO_AUTO_UPDATE=1 brew cask install google-chrome > /dev/null

          # https://developers.google.com/web/updates/2017/04/headless-chrome
          alias google-chrome="/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome"

          # verify installation
          google-chrome --version
        elif cat /etc/issue | grep Alpine >> /dev/null 2>&1; then
          echo @edge http://nl.alpinelinux.org/alpine/edge/community >> /etc/apk/repositories
          echo @edge http://nl.alpinelinux.org/alpine/edge/main >> /etc/apk/repositories

          apk add --no-cache \
            chromium@edge \
            harfbuzz@edge \
            nss@edge \
            freetype@edge \
            ttf-freefont@edge

          rm -rf /var/cache/*
          mkdir /var/cache/apk

          # verify installation
          chromium-browser --version
        else
          # download chrome
          curl --silent --show-error --location --fail --retry 3 \
            --output google-chrome-stable_current_amd64.deb \
            https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb

          # setup chrome installation
          $SUDO dpkg -i google-chrome-stable_current_amd64.deb || $SUDO apt-get -fy install

          rm -rf google-chrome-stable_current_amd64.deb

          $SUDO sed -i 's|HERE/chrome"|HERE/chrome" --disable-setuid-sandbox --no-sandbox|g' \
              "/opt/google/chrome/google-chrome"

          # verify installation
          google-chrome --version
        fi
