description: >
  Install Google's Chromedriver WebDriver proxy, for use in browser
  testing with Chrome. A Chromedriver version will be dynamically
  selected based on the installed version of Chrome; for details, see
  https://sites.google.com/a/chromium.org/chromedriver/downloads/version-selection
  Requirements: sed, curl, unzip

steps:
  - run:
      name: Install Chromedriver
      command: |
        if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi

        # determine_chrome_version
        if uname -a | grep Darwin > /dev/null 2>&1; then

          CHROME_VERSION="$(/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --version)"

        elif cat /etc/issue | grep Alpine > /dev/null 2>&1; then

          CHROME_VERSION="$(chromium-browser --version)"
        else
          CHROME_VERSION="$(google-chrome --version)"
        fi

        CHROME_VERSION_STRING="$(echo $CHROME_VERSION | sed 's/^Google Chrome //' | sed 's/^Chromium //')"

        echo "Installed version of Google Chrome/Chromium is $CHROME_VERSION_STRING"

        # determine chromedriver release
        CHROMEDRIVER_RELEASE="${CHROME_VERSION_STRING%%.*}"

        let CHROME_RELEASE=$CHROMEDRIVER_RELEASE

        if [[ $CHROME_RELEASE -lt 70]]; then
          # https://sites.google.com/a/chromium.org/chromedriver/downloads
          # https://chromedriver.storage.googleapis.com/2.40/notes.txt
          case $CHROME_RELEASE in
          69)
            CHROMEDRIVER_VERSION="2.44";;
          68)
            CHROMEDRIVER_VERSION="2.42";;
          67)
            CHROMEDRIVER_VERSION="2.41";;
          66)
            CHROMEDRIVER_VERSION="2.40";;
          65)
            CHROMEDRIVER_VERSION="2.38";;
          64)
            CHROMEDRIVER_VERSION="2.37";;
          63)
            CHROMEDRIVER_VERSION="2.36";;
          62)
            CHROMEDRIVER_VERSION="2.35";;
          61)
            CHROMEDRIVER_VERSION="2.34";;
          60)
            CHROMEDRIVER_VERSION="2.33";;
          59)
            CHROMEDRIVER_VERSION="2.32";;
          58)
            CHROMEDRIVER_VERSION="2.31";;
          [56-57])
            CHROMEDRIVER_VERSION="2.29";;
          55)
            CHROMEDRIVER_VERSION="2.28";;
          54)
            CHROMEDRIVER_VERSION="2.27";;
          53)
            CHROMEDRIVER_VERSION="2.26";;
          52)
            CHROMEDRIVER_VERSION="2.24";;
          51)
            CHROMEDRIVER_VERSION="2.23";;
          [49-50])
            CHROMEDRIVER_VERSION="2.22";;
          [46-48])
            CHROMEDRIVER_VERSION="2.21";;
          [43-45])
            CHROMEDRIVER_VERSION="2.20";;
          *)
            echo "Sorry, Google Chrome/Chromium version 43 or newer is required to use Chromedriver"
            exit 1;;
          esac
        else
          CHROMEDRIVER_VERSION=$(curl --silent --show-error --location --fail --retry 3 \
            "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROMEDRIVER_RELEASE")
        fi

        echo "Chromedriver $CHROMEDRIVER_VERSION will be installed"

        if false; then
          # download chromedriver
          curl --silent --show-error --location --fail --retry 3 \
            --output chromedriver_linux64.zip \
            "http://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"

          # setup chromedriver installation
          unzip chromedriver_linux64.zip
          rm -rf chromedriver_linux64.zip

          sudo mv chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

          # verify version
          chromedriver --version
        fi
