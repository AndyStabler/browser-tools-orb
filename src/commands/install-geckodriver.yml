description: >
  Install Mozilla's Geckodriver WebDriver proxy, for use in browser
  testing with Firefox. Requirements: apt-get, curl, tar

parameters:
  version:
    type: string
    default: latest
    description: >
      Version of Geckodriver to install, defaults to latest release. To
      install an older release, specify a full semantic version tag,
      e.g., `v0.23.0`. For a list of releases, see the following link:
      https://github.com/mozilla/geckodriver/releases

steps:
  - run:
      name: Install Geckodriver
      command: |
        if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi

        $SUDO apt-get install -y jq

        if [[ <<parameters.version>> == "latest" ]]; then
          # extract latest version from github releases API
          GECKODRIVER_VERSION_STRING=$(curl \
            https://api.github.com/repos/mozilla/geckodriver/releases/latest | jq '.tag_name')

          # strip leading/trailing "
          temp="${GECKODRIVER_VERSION_STRING%\"}"
          GECKODRIVER_VERSION="${temp#\"}"
        else
          GECKODRIVER_VERSION=<<parameters.version>>
        fi

        # get download URL
        GECKODRIVER_URL=$(curl \
          "https://api.github.com/repos/mozilla/geckodriver/releases/tags/$GECKODRIVER_VERSION" | \
          jq -r ".assets[] | select(.name | test(\"linux64\")) | .browser_download_url")

        # download geckodriver
        curl --silent --show-error --location --fail --retry 3 --output "geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz" "$GECKODRIVER_URL"

        # setup geckodriver installation
        tar xf "geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz"
        rm -rf "geckodriver-$GECKODRIVER_VERSION-linux64.tar.gz"

        $SUDO mv geckodriver /usr/local/bin/geckodriver
        $SUDO chmod +x /usr/local/bin/geckodriver

        # verify version
        geckodriver --version
